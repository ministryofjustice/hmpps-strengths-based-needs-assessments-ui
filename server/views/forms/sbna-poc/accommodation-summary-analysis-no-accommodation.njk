{% extends "../layout.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "components/question/macro.njk" import renderQuestion %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}

{%- macro renderSelectedOptions(field) -%}
  <ul class="govuk-list">
    {% for option in field.options %}
      {% if option.checked %}
        <li>
          {{ option.text }}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderCurrentAccommodation(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["current_accommodation"].options %}
      {% if option.checked %}
        <li class="summary-details-list">
          <span>{{ option.text }}</span>
          {% switch option.value %}
          {% case "SETTLED" %}
            <span>{{ renderSettledAccommodationType(fields["type_of_settled_accommodation"]) }}</span>
          {% case "TEMPORARY" %}
            <span>{{ renderTemporaryAccommodationType(fields, answers) }}</span>
          {% case "NO_ACCOMMODATION" %}
            <span>{{ renderNoAccommodationType(fields, answers) }}</span>
          {% endswitch %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderSettledAccommodationType(field) -%}
    {% for option in field.options %}
      {% if option.checked %}
        <span class="govuk-!-font-size-14">{{ option.text }}</span>
      {% endif %}
    {% endfor %}
{%- endmacro -%}

{%- macro renderTemporaryAccommodationType(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["type_of_temporary_accommodation"].options %}
      {% if option.checked %}
        <li class="summary-details-list">
          <span class="govuk-!-font-size-14">{{ option.text }}</span>
          <span class="govuk-!-font-size-14">Expected end date:</span>
          {% switch option.value %}
            {% case "SHORT_TERM" %}
              <span class="govuk-!-font-size-14">{{ answers["short_term_accommodation_end_date"] | default('Not provided') }}</span>
            {% case "APPROVED_PREMISES" %}
              <span class="govuk-!-font-size-14">{{ answers["approved_premises_end_date"] | default('Not provided') }}</span>
            {% case "CAS2" %}
              <span class="govuk-!-font-size-14">{{ answers["cas2_end_date"] | default('Not provided') }}</span>
            {% case "CAS3" %}
              <span class="govuk-!-font-size-14">{{ answers["cas3_end_date"] | default('Not provided') }}</span>
            {% case "IMMIGRATION" %}
              <span class="govuk-!-font-size-14">{{ answers["immigration_accommodation_end_date"] | default('Not provided') }}</span>
          {% endswitch %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderNoAccommodationType(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["type_of_no_accommodation"].options %}
      {% if option.checked %}
        <li class="summary-details-list">
          <span class="govuk-!-font-size-14">{{ option.text }}</span>
          {% switch option.value %}
            {% case "AWAITING_ASSESSMENT" %}
              <span class="govuk-!-font-size-14">{{ answers["awaiting_assessment_details"] }}</span>
          {% endswitch %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderNoAccommodationReason(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["no_accommodation_reason"].options %}
        {% if option.checked %}
        <li class="summary-details-list">
          <span>{{ option.text }}</span>
          {% if option.value == "OTHER" %}
            <span class="govuk-!-font-size-14">{{ answers["no_accommodation_reason_other_details"] }}</span>
          {% endif %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderAccommodationChangeDetails(answers) -%}
{%- switch answers["accommodation_changes"] -%}
  {% case "MADE_CHANGES" %}
    {{ answers["accommodation_made_changes_details"] }}
  {% case "MAKING_CHANGES" %}
    {{ answers["accommodation_making_changes_details"] }}
  {% case "WANT_TO_MAKE_CHANGES" %}
    {{ answers["accommodation_want_to_make_changes_details"] }}
  {% case "NEEDS_HELP_TO_MAKE_CHANGES" %}
    {{ answers["accommodation_needs_help_to_make_changes_details"] }}
  {% case "THINKING_ABOUT_MAKING_CHANGES" %}
    {{ answers["accommodation_thinking_about_making_changes_details"] }}
  {% case "DOES_NOT_WANT_TO_MAKE_CHANGES" %}
    {{ answers["accommodation_does_not_want_to_make_changes_details"] }}
  {% default %}
{%- endswitch -%}
{%- endmacro -%}

{%- macro renderSuitableHousingPlanned(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["suitable_housing_planned"].options %}
      {% if option.checked %}
        <li class="summary-details-list">
          <span>{{ option.text }}</span>
          {% switch option.value %}
          {% case "AWAITING_ASSESSMENT" %}
            <span class="govuk-!-font-size-14">{{ answers["suitable_housing_planned_awaiting_assessment_details"] }}</span>
          {% case "AWAITING_PLACEMENT" %}
            <span class="govuk-!-font-size-14">{{ answers["awaiting_accommodation_placement_details"] }}</span>
          {% case "OTHER" %}
            <span class="govuk-!-font-size-14">{{ answers["suitable_housing_planned_other_details"] }}</span>
          {% endswitch %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderAccommodationChange(fields, answers) -%}
  <ul class="govuk-list">
    {% for option in fields["accommodation_changes"].options %}
        {% if option.checked %}
        <li class="summary-details-list">
          <span>{{ option.text }}</span>
          {%- switch option.value -%}
            {% case "MADE_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_made_changes_details"] }}</span>
            {% case "MAKING_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_making_changes_details"] }}</span>
            {% case "WANT_TO_MAKE_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_want_to_make_changes_details"] }}</span>
            {% case "NEEDS_HELP_TO_MAKE_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_needs_help_to_make_changes_details"] }}</span>
            {% case "THINKING_ABOUT_MAKING_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_thinking_about_making_changes_details"] }}</span>
            {% case "DOES_NOT_WANT_TO_MAKE_CHANGES" %}
              <span class="govuk-!-font-size-14">{{ answers["accommodation_does_not_want_to_make_changes_details"] }}</span>
            {% default %}
          {%- endswitch -%}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{%- endmacro -%}

{%- macro renderSummaryListRow(label, value, changeLink) -%}
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{ label }}
    </dt>
    <dd class="govuk-summary-list__value">
      {{ value }}
    </dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="{{ changeLink }}">
      Change<span class="govuk-visually-hidden">value for {{ label }}</span>
      </a>
    </dd>
  </div>
{%- endmacro -%}

{% set accommodationSummaryHtml %}
<dl class="govuk-summary-list">
  {{ renderSummaryListRow(
    options.allFields["current_accommodation"].text,
    renderCurrentAccommodation(options.allFields, answers),
    "accommodation#current-accommodation"
  ) }}
  {%- if answers["type_of_no_accommodation"] != "AWAITING_ASSESSMENT" -%}
  {{ renderSummaryListRow(
    options.allFields["no_accommodation_reason"].text,
    renderNoAccommodationReason(options.allFields, answers),
    "accommodation#current-accommodation"
  ) }}
  {{ renderSummaryListRow(
    options.allFields["past_accommodation_details"].text,
    options.allFields["past_accommodation_details"].value,
    backLink + "#suitable_housing_location"
  ) }}
  {{ renderSummaryListRow(
    options.allFields["suitable_housing_planned"].text,
    renderSuitableHousingPlanned(options.allFields, answers),
    backLink + "#suitable_housing"
  ) }}
  {%- endif -%}
  {{ renderSummaryListRow(
    options.allFields["accommodation_changes"].text,
    renderAccommodationChange(options.allFields, answers),
    backLink + "#accommodation_changes"
  ) }}
</dl>
{% endset -%}

{% set practitionerAnalysisHtml %}
{{ renderQuestion(options.fields["accommodation_practitioner_analysis"], errors) }}
{{ renderQuestion(options.fields["accommodation_serious_harm"], errors) }}
{{ renderQuestion(options.fields["accommodation_risk_of_reoffending"], errors) }}

<div class="questiongroup-action-buttons">
  {{ govukButton({
    text: buttonText | default("Mark as complete"),
    classes: "govuk-!-margin-bottom-3 govuk-!-margin-right-1"
  }) }}
</div>
{% endset -%}

{% block formContent %}
  <form method="post" action="{{ action }}">
    <input type="hidden" name="x-csrf-token" value="{{ getCsrf() }}">
    {{ govukTabs({
      items: [
        {
          label: "Accommodation summary",
          id: "accommodation-summary",
          panel: {
            html: accommodationSummaryHtml
          }
        },
        {
          label: "Practitioner analysis",
          id: "practitioner-analysis",
          panel: {
            html: practitionerAnalysisHtml
          }
        }
      ]
    }) }}
  </form>
{% endblock %}
