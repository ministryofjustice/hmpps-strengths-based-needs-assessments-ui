{% extends "../layout.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "components/summary/macro.njk" import renderSummaryFields %}

{% set summaryFields = getSummaryFields({section: options.section, allFields: options.allFields, steps: options.steps, answers: answers}) %}
{% set sectionStarted = summaryFields.singleFields.length > 0 or summaryFields.collectionFields.length > 0 %}
{% set sectionComplete = sectionProgress[options.section] %}

{% macro renderAnalysisSummaryRow(label, field, yesDetailsField, noDetailsField, link) %}
  <div class="govuk-summary-list__row summary-list__row">
    <dt class="govuk-summary-list__key summary-list__key">
      <span class="summary__label">{{ label }}</span>
    </dt>
    <dd class="govuk-summary-list__value summary-list__value">
      <ul class="govuk-list">
        {% for option in field.options %}
          {% if option.checked %}
            {% if option.value === "YES" %}
              {% set detailsAnswer = yesDetailsField.value %}
            {% else %}
              {% set detailsAnswer = noDetailsField.value %}
            {% endif %}

            <li class="summary-details-list">
              <span class="summary__answer">{{ option.text | safe }}</span>
              <p class="analysis__answer--secondary">{{ detailsAnswer | nl2br | safe }}</p>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </dd>
    {% if sessionData.user | isInEditMode %}
      <dd class="govuk-summary-list__actions summary-list__actions">
        <a class="govuk-link" href="{{ summary.changeLink }}">
        Change<span class="govuk-visually-hidden">value for {{ summary.field.text }}</span>
        </a>
      </dd>
    {% endif %}
  </div>
{% endmacro %}

{% if sessionData.user | isInEditMode %}
  {% set shouldShowAnalaysis = not hideAnalysis %}
{% else %}
  {% set shouldShowAnalaysis = not hideAnalysis and practitionerAnalysisStarted(form, answers) %}
{% endif %}

{% block notification %}
  {% if not sessionData.user | isInEditMode and sectionStarted and not sectionComplete %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        {{ mojBanner({ type: "information", text: "This section is incomplete" }) }}
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block formContent %}
  <h2 class="govuk-heading-m">
    Summary
  </h2>
  <div class="summary__panel" id="summary">
    <form id="form" method="post">
      <input type="hidden" name="x-csrf-token" value="{{ getCsrf() }}">
      {{ renderSummaryFields(summaryFields, sessionData) }}
    </form>
  </div>
  {% if shouldShowAnalaysis %}
    <h2 class="govuk-heading-m">
      Practitioner analysis
    </h2>
    <div class="summary__panel" id="practitioner-analysis">
      {% set section = options.section | replace("-", "_") %}
      {% set fields = options.allFields %}
      {% set changeLink = options.section + '-summary' %}

      <dl class="govuk-summary-list summary-list"></dl>
      <section>
        {{ renderAnalysisSummaryRow(
          "Strengths or protective factors",
          fields[section + "_practitioner_analysis_strengths_or_protective_factors"],
          fields[section + "_practitioner_analysis_strengths_or_protective_factors_yes_details"],
          fields[section + "_practitioner_analysis_strengths_or_protective_factors_no_details"],
          changeLink
        ) }}
        <hr class="govuk-section-break govuk-section-break--l">
        {{ renderAnalysisSummaryRow(
          "Linked to risk of serious harm",
          fields[section + "_practitioner_analysis_risk_of_serious_harm"],
          fields[section + "_practitioner_analysis_risk_of_serious_harm_yes_details"],
          fields[section + "_practitioner_analysis_risk_of_serious_harm_no_details"],
          changeLink
        ) }}
        <hr class="govuk-section-break govuk-section-break--l">
        {{ renderAnalysisSummaryRow(
          "Linked to risk of reoffending",
          fields[section + "_practitioner_analysis_risk_of_reoffending"],
          fields[section + "_practitioner_analysis_risk_of_reoffending_yes_details"],
          fields[section + "_practitioner_analysis_risk_of_reoffending_no_details"],
          changeLink
        ) }}
      </section>
    </div>
  {% endif %}
</div>
{% endblock %}
