name: Get end-to-end test timings

on:
  workflow_call:
    inputs:
      spec-file-patterns:
        type: string
        required: true
        description: 'For example: e2e/**/*.cy.ts e2e/**/*.cy.js'
    outputs:
      timings:
        description: "timings.json"
        value: ${{ jobs.get-timings.outputs.timings }}

permissions:
  contents: read

jobs:
  get-timings:
    runs-on: ubuntu-latest
    outputs:
      timings: ${{ steps.get-timings.outputs.timings }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore timing cache
        uses: actions/cache/restore@v4
        with:
          path: timings-cache.json
          key: timings-cache.json
      - name: Get cached timings
        id: get-cached-timings
        run: |
          if ls timings-cache.json; then cat timings-cache.json && echo "timings=$(jq -c . < timings-cache.json)" >> $GITHUB_OUTPUT; else echo "timings=" >> $GITHUB_OUTPUT; fi
      - name: Find spec files
        if: ${{ steps.get-cached-timings.outputs.timings != '' }}
        run: |
          find ${{ inputs.spec-file-patterns }} -type f \
            | while read -r spec; do \
              hash=$(md5sum "$spec" | cut -d " " -f1); \
              echo "{\"spec\": \"$spec\", \"hash\": \"$hash\"}"; \
            done \
            | jq -s '.' > spec-hashes.json
      - name: Create timings.json
        if: ${{ steps.get-cached-timings.outputs.timings != '' }}
        run: |
          cat timings-cache.json \
          | jq --argjson specs "$(jq '[.[] | {spec, hash}]' spec-hashes.json)" \
            '.durations | map(select([.spec, .hash] as $entry | $specs | any(.spec == $entry[0] and .hash == $entry[1])) | {spec, duration})' \
          | jq '{durations: .}' > timings.json
      - name: Get timings.json
        id: get-timings
        run: |
          if ls timings.json; then echo "timings=$(jq -c . < timings.json)" >> $GITHUB_OUTPUT; else echo "timings=" >> $GITHUB_OUTPUT; fi
